<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>AIS ì„ ë°• í´ëŸ¬ìŠ¤í„° ì§€ë„ (OpenStreetMap)</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""
    />

    <!-- Leaflet MarkerCluster CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
    />
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
    />

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }

        /* í´ëŸ¬ìŠ¤í„° ìƒ‰ìƒ ì»¤ìŠ¤í„°ë§ˆì´ì§• */
        .marker-cluster-small {
            background-color: rgba(0, 150, 0, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(0, 200, 0, 0.9);
        }

        .marker-cluster-medium {
            background-color: rgba(255, 165, 0, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(255, 200, 0, 0.9);
        }

        .marker-cluster-large {
            background-color: rgba(200, 0, 0, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(255, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""
    ></script>

    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <script>
        // ====== 1. ê¸°ë³¸ ì§€ë„ ì„¸íŒ… (ëŒ€ì¶© í•œë°˜ë„ ë™ë‚¨ë¶€ ìª½ / ë‚˜ì¤‘ì— fitBoundsë¡œ ìë™ ì¡°ì •ë¨) ======
        const map = L.map("map").setView([34.5, 127.5], 7);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
            attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        // ====== 2. í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ìƒì„± (ë°€ì§‘ë„ì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½) ======
        const markers = L.markerClusterGroup({
            iconCreateFunction: function (cluster) {
                const count = cluster.getChildCount();
                let sizeClass = " marker-cluster-small";

                // ë°€ì§‘ë„ ê¸°ì¤€ì€ í•„ìš”ì— ë”°ë¼ ì¡°ì •
                if (count > 30) {
                    sizeClass = " marker-cluster-large";
                } else if (count > 10) {
                    sizeClass = " marker-cluster-medium";
                }

                return new L.DivIcon({
                    html: "<div><span>" + count + "</span></div>",
                    className: "marker-cluster" + sizeClass,
                    iconSize: new L.Point(40, 40),
                });
            },
        });

        // ====== 3. JSON íŒŒì¼ë“¤ ë¡œë”© ======
        // data/aisResult0.json ~ data/aisResult45.json ê°€ì •
        const FILE_COUNT = 128;
        const BASE_PATH = "./ais_results/";

        const fileNames = Array.from({ length: FILE_COUNT }, (_, i) => {
            return `${BASE_PATH}aisResult${i}.json`;
        });

       async function loadAllShipPoints() {
    const allPoints = [];

    const promises = fileNames.map(async (filePath) => {
        try {
            const res = await fetch(filePath);
            if (!res.ok) {
                console.warn("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:", filePath, res.status);
                return;
            }
            const data = await res.json();

            // íŒŒì¼ êµ¬ì¡°: { mmsi: "538003729", PredResult: [ {...}, {...}, ... ] }
            if (!data || !Array.isArray(data.PredResult)) return;

            const track = data.PredResult;
            if (track.length === 0) return;

            // ğŸ”¹ ì—¬ê¸°ì„œ track ì „ì²´(ëª¨ë“  SEQ)ë¥¼ ìˆœíšŒ
            track.forEach((pt) => {
                const lat = pt.AFTER_LAT;
                const lon = pt.AFTER_LON;

                if (typeof lat !== "number" || typeof lon !== "number") return;

                allPoints.push({
                    mmsi: data.mmsi || "UNKNOWN",
                    lat: lat,
                    lon: lon,
                    sog: pt.SOG,
                    time: pt.ARRIVALTIME,
                    seq: pt.SEQ
                });
            });
        } catch (err) {
            console.error("íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:", filePath, err);
        }
    });

    await Promise.all(promises);
    return allPoints;
}

        // ====== 4. ë¡œë”© í›„ ì§€ë„ì— í´ëŸ¬ìŠ¤í„°ë¡œ í‘œì‹œ ======
        (async () => {
            const points = await loadAllShipPoints();

            if (!points || points.length === 0) {
                console.warn("í‘œì‹œí•  ì„ ë°• ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            points.forEach((ship) => {
                const marker = L.circleMarker([ship.lat, ship.lon], {
                    radius: 5,
                });

                marker.bindPopup(
                    `<b>MMSI:</b> ${ship.mmsi}<br>` +
                    `<b>SOG:</b> ${ship.sog ?? "-"} kn<br>` +
                    `<b>ARRIVALTIME:</b> ${ship.time ?? "-"}<br>` +
                    `<b>Lat:</b> ${ship.lat.toFixed(5)}<br>` +
                    `<b>Lon:</b> ${ship.lon.toFixed(5)}`
                );

                markers.addLayer(marker);
            });

            map.addLayer(markers);

            // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ì˜ì—­ ë§ì¶”ê¸°
            const bounds = markers.getBounds();
            if (bounds.isValid()) {
                map.fitBounds(bounds.pad(0.2));
            }
        })();
    </script>
</body>
</html>
